# NovyWave HDL Examples Justfile
# Comprehensive build and simulation orchestration for all example HDL projects

# Default recipe: show help
default:
    @just --list

# === TOOL INSTALLATION ===

# Install all tools required to run all examples
install-all: install-ghdl install-iverilog install-verilator install-sbt install-amaranth install-spade
    @echo "âœ… All tools installed!"

# Install GHDL (VHDL simulator)
install-ghdl:
    @echo "ğŸ“¦ Installing GHDL..."
    @if command -v ghdl >/dev/null 2>&1; then \
        echo "  âœ“ GHDL already installed: $(ghdl --version | head -1)"; \
    else \
        echo "  Installing via apt..."; \
        sudo apt update && sudo apt install -y ghdl; \
    fi

# Install Icarus Verilog (Verilog simulator)
install-iverilog:
    @echo "ğŸ“¦ Installing Icarus Verilog..."
    @if command -v iverilog >/dev/null 2>&1; then \
        echo "  âœ“ Icarus Verilog already installed: $(iverilog -V 2>&1 | head -1)"; \
    else \
        echo "  Installing via apt..."; \
        sudo apt update && sudo apt install -y iverilog; \
    fi

# Install Verilator (for SpinalHDL simulation)
install-verilator:
    @echo "ğŸ“¦ Installing Verilator..."
    @if command -v verilator >/dev/null 2>&1; then \
        echo "  âœ“ Verilator already installed: $(verilator --version)"; \
    else \
        echo "  Installing via apt..."; \
        sudo apt update && sudo apt install -y verilator; \
    fi

# Install sbt via Coursier (for SpinalHDL)
install-sbt:
    @echo "ğŸ“¦ Installing sbt via Coursier..."
    @if command -v sbt >/dev/null 2>&1 || [ -f "$HOME/.local/share/coursier/bin/sbt" ]; then \
        echo "  âœ“ sbt already installed"; \
    else \
        echo "  Installing Coursier and sbt..."; \
        curl -fL https://github.com/coursier/coursier/releases/latest/download/cs-x86_64-pc-linux.gz | gzip -d > /tmp/cs; \
        chmod +x /tmp/cs; \
        /tmp/cs setup --yes; \
        rm /tmp/cs; \
        echo "  âš ï¸  Run: export PATH=\"\$HOME/.local/share/coursier/bin:\$PATH\""; \
    fi

# Install Amaranth HDL (Python-based HDL) - creates venv in amaranth/counter
install-amaranth:
    @echo "ğŸ“¦ Installing Amaranth..."
    @if [ -f amaranth/counter/.venv/bin/python ]; then \
        echo "  âœ“ Amaranth venv already exists"; \
    else \
        echo "  Creating virtual environment and installing..."; \
        cd amaranth/counter && python3 -m venv .venv && .venv/bin/pip install amaranth; \
        echo "  âœ“ Amaranth installed in amaranth/counter/.venv"; \
    fi

# Install Spade HDL (Rust-based HDL)
install-spade:
    @echo "ğŸ“¦ Installing Spade..."
    @if command -v spade >/dev/null 2>&1; then \
        echo "  âœ“ Spade already installed: $(spade --version 2>&1)"; \
    else \
        echo "  Installing via cargo..."; \
        cargo install spade-lang; \
    fi

# Check which tools are installed
check-tools:
    @echo "ğŸ” Checking installed tools..."
    @echo ""
    @echo "VHDL (GHDL):"
    @if command -v ghdl >/dev/null 2>&1; then echo "  âœ“ $(ghdl --version | head -1)"; else echo "  âœ— Not installed"; fi
    @echo ""
    @echo "Verilog (Icarus Verilog):"
    @if command -v iverilog >/dev/null 2>&1; then echo "  âœ“ $(iverilog -V 2>&1 | head -1)"; else echo "  âœ— Not installed"; fi
    @echo ""
    @echo "Verilator:"
    @if command -v verilator >/dev/null 2>&1; then echo "  âœ“ $(verilator --version)"; else echo "  âœ— Not installed"; fi
    @echo ""
    @echo "sbt (for SpinalHDL):"
    @if command -v sbt >/dev/null 2>&1; then echo "  âœ“ sbt available in PATH"; \
    elif [ -f "$HOME/.local/share/coursier/bin/sbt" ]; then echo "  âœ“ sbt installed via Coursier (add to PATH)"; \
    else echo "  âœ— Not installed"; fi
    @echo ""
    @echo "Amaranth (Python):"
    @if [ -f amaranth/counter/.venv/bin/python ]; then echo "  âœ“ Amaranth venv available"; \
    elif python3 -c "import amaranth" 2>/dev/null; then echo "  âœ“ Amaranth available (system)"; \
    else echo "  âœ— Not installed (run: just install-amaranth)"; fi
    @echo ""
    @echo "Spade:"
    @if command -v spade >/dev/null 2>&1; then echo "  âœ“ Spade available"; else echo "  âœ— Not installed"; fi

# === BUILD ALL ===

# Build and simulate all examples (generates VCD/GHW files)
sim-all: sim-vhdl sim-verilog sim-spinalhdl sim-amaranth sim-spade
    @echo ""
    @echo "âœ… All simulations complete!"
    @echo ""
    @just list-waveforms

# Clean all example build artifacts
clean-all: clean-vhdl clean-verilog clean-spinalhdl clean-amaranth clean-spade
    @echo "ğŸ§¹ All examples cleaned!"

# List all generated waveform files
list-waveforms:
    #!/usr/bin/env bash
    echo "ğŸ“Š Generated waveform files:"
    echo ""
    for f in vhdl/counter/counter.ghw verilog/counter/counter.vcd spinalhdl/counter/counter.vcd amaranth/counter/counter.vcd spade/counter/counter.vcd; do
        if [ -f "$f" ]; then
            size=$(ls -lh "$f" | awk '{print $5}')
            echo "  âœ“ $f ($size)"
        else
            echo "  âœ— $f (not generated)"
        fi
    done

# === INDIVIDUAL EXAMPLES ===

# VHDL example (using GHDL)
sim-vhdl:
    @echo "ğŸ”§ Building VHDL counter example..."
    @cd vhdl/counter && make

clean-vhdl:
    @cd vhdl/counter && make clean

# Verilog example (using Icarus Verilog)
sim-verilog:
    @echo "ğŸ”§ Building Verilog counter example..."
    @cd verilog/counter && make

clean-verilog:
    @cd verilog/counter && make clean

# SpinalHDL example (using sbt + Verilator)
sim-spinalhdl:
    #!/usr/bin/env bash
    echo "ğŸ”§ Building SpinalHDL counter example..."
    export PATH="$HOME/.local/share/coursier/bin:$PATH"
    cd spinalhdl/counter && make

clean-spinalhdl:
    @cd spinalhdl/counter && make clean

# Amaranth example (using Python)
sim-amaranth:
    @echo "ğŸ”§ Building Amaranth counter example..."
    @cd amaranth/counter && make

clean-amaranth:
    @cd amaranth/counter && make clean

# Spade example (using Spade + Icarus Verilog)
sim-spade:
    @echo "ğŸ”§ Building Spade counter example..."
    @cd spade/counter && make

clean-spade:
    @cd spade/counter && make clean

# === RTL GENERATION (SpinalHDL) ===

# Generate Verilog RTL from SpinalHDL
gen-verilog-from-spinalhdl:
    #!/usr/bin/env bash
    echo "ğŸ”§ Generating Verilog RTL from SpinalHDL..."
    export PATH="$HOME/.local/share/coursier/bin:$PATH"
    cd spinalhdl/counter && make verilog

# Generate VHDL RTL from SpinalHDL
gen-vhdl-from-spinalhdl:
    #!/usr/bin/env bash
    echo "ğŸ”§ Generating VHDL RTL from SpinalHDL..."
    export PATH="$HOME/.local/share/coursier/bin:$PATH"
    cd spinalhdl/counter && make vhdl

# === VALIDATION ===

# Build the Rust validation tool
build-validator:
    @echo "ğŸ”§ Building Rust validation tool..."
    @cd validate && cargo build --release

# Validate all waveform files (format, structure, signals)
validate: build-validator
    @./validate/target/release/validate-waveforms

# Validate with verbose output (shows found signal names)
validate-verbose: build-validator
    @./validate/target/release/validate-waveforms --verbose

# === INTEGRATION TESTING ===

# Run integration tests using NovyWave's wellen backend
integration-test: build-validator
    #!/usr/bin/env bash
    set -e
    echo ""
    echo "============================================================"
    echo "  NovyWave Integration Tests (using NovyWave backend tools)"
    echo "============================================================"
    echo ""

    # Try to build and use inspect_fst if backend is available
    INSPECT_BIN="../backend/target/release/inspect_fst"
    USE_INSPECT=false

    if [ -f "$INSPECT_BIN" ]; then
        USE_INSPECT=true
        echo "Using NovyWave backend inspect_fst"
    else
        echo "â„¹ï¸  NovyWave inspect_fst not available (run 'cargo build --release' in backend/)"
        echo "   Using validation tool (same wellen library)"
    fi
    echo ""

    # Test each waveform file
    PASS=0
    FAIL=0

    for file in vhdl/counter/counter.ghw verilog/counter/counter.vcd spinalhdl/counter/counter.vcd amaranth/counter/counter.vcd spade/counter/counter.vcd; do
        printf "%-45s " "$file"

        if [ ! -f "$file" ]; then
            echo "âŒ NOT FOUND"
            FAIL=$((FAIL + 1))
            continue
        fi

        if [ "$USE_INSPECT" = true ]; then
            if $INSPECT_BIN "$file" > /tmp/inspect_out.txt 2>&1; then
                FORMAT=$(grep "^format:" /tmp/inspect_out.txt | awk '{print $2}')
                echo "âœ“ $FORMAT"
                PASS=$((PASS + 1))
            else
                echo "âŒ FAILED"
                FAIL=$((FAIL + 1))
            fi
        else
            # Use validation tool - check if this specific file passes
            if ./validate/target/release/validate-waveforms 2>&1 | grep -A15 "$file" | grep -q "PASSED"; then
                echo "âœ“ validated"
                PASS=$((PASS + 1))
            else
                echo "âŒ FAILED"
                FAIL=$((FAIL + 1))
            fi
        fi
    done

    echo ""
    echo "============================================================"
    echo "  Results: $PASS passed, $FAIL failed out of 5"
    echo "============================================================"

    if [ $FAIL -gt 0 ]; then
        exit 1
    fi

# Test a single waveform file with NovyWave backend
test-file file:
    #!/usr/bin/env bash
    echo "Testing {{file}} with NovyWave backend..."
    cd .. && cargo run --release --bin inspect_fst -- "examples/{{file}}" 2>&1
    echo ""
    echo "Validation check:"
    cd examples && ./validate/target/release/validate-waveforms --verbose 2>&1 | grep -A 20 "$(basename {{file}})" | head -25

# === QUICK START ===

# Quick start: install tools, run simulations, and validate
quickstart: install-all sim-all validate
    @echo ""
    @echo "ğŸ‰ Quick start complete! All waveform files generated and validated."
    @echo ""
    @echo "Open any waveform file in NovyWave:"
    @echo "  novywave examples/vhdl/counter/counter.ghw"
    @echo "  novywave examples/verilog/counter/counter.vcd"
    @echo "  novywave examples/spinalhdl/counter/counter.vcd"
    @echo "  novywave examples/amaranth/counter/counter.vcd"
    @echo "  novywave examples/spade/counter/counter.vcd"

# === DEVELOPMENT ===

# Watch and rebuild a specific example (for development)
watch example:
    @echo "ğŸ‘€ Watching {{example}} for changes..."
    @if [ "{{example}}" = "vhdl" ]; then \
        cd vhdl/counter && while true; do inotifywait -e modify *.vhd && make; done; \
    elif [ "{{example}}" = "verilog" ]; then \
        cd verilog/counter && while true; do inotifywait -e modify *.v && make; done; \
    elif [ "{{example}}" = "spinalhdl" ]; then \
        export PATH="$$HOME/.local/share/coursier/bin:$$PATH" && \
        cd spinalhdl/counter && while true; do inotifywait -e modify src/main/scala/counter/*.scala && make; done; \
    elif [ "{{example}}" = "amaranth" ]; then \
        cd amaranth/counter && while true; do inotifywait -e modify *.py && make; done; \
    elif [ "{{example}}" = "spade" ]; then \
        cd spade/counter && while true; do inotifywait -e modify *.spade && make; done; \
    else \
        echo "Unknown example: {{example}}"; \
        echo "Available: vhdl, verilog, spinalhdl, amaranth, spade"; \
    fi

# === E2E UI TESTING ===

# Install E2E test dependencies (Playwright)
install-e2e:
    @echo "ğŸ“¦ Installing E2E test dependencies..."
    @cd e2e-tests && npm install && npm run install-browsers
    @echo "âœ… E2E dependencies installed!"

# Run E2E tests (requires NovyWave dev server running)
e2e-test:
    @echo "ğŸ­ Running E2E tests with Playwright..."
    @echo ""
    @echo "âš ï¸  Make sure NovyWave dev server is running (makers start)"
    @echo ""
    @cd e2e-tests && npm test

# Run E2E tests in headed mode (visible browser)
e2e-test-headed:
    @echo "ğŸ­ Running E2E tests (headed mode)..."
    @cd e2e-tests && npm run test:headed

# Run E2E tests in debug mode
e2e-test-debug:
    @echo "ğŸ­ Running E2E tests (debug mode)..."
    @cd e2e-tests && npm run test:debug

# Run E2E tests with Playwright UI
e2e-test-ui:
    @echo "ğŸ­ Opening Playwright Test UI..."
    @cd e2e-tests && npm run test:ui

# Show E2E test report
e2e-report:
    @echo "ğŸ“Š Opening E2E test report..."
    @cd e2e-tests && npx playwright show-report

# Clean E2E test artifacts
clean-e2e:
    @echo "ğŸ§¹ Cleaning E2E test artifacts..."
    @rm -rf e2e-tests/node_modules e2e-tests/playwright-report e2e-tests/test-results
    @echo "âœ… E2E artifacts cleaned!"

# Full test suite (validation + E2E)
test-all: validate e2e-test
    @echo ""
    @echo "âœ… All tests complete!"
