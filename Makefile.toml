[config]
default_to_workspace = false
min_version = "0.35.13"
unstable_features = ["CTRL_C_HANDLING"]
skip_core_tasks = true

[config.modify_core_tasks]
private = true
namespace = "default"

#######  MAIN TASKS  #######

[tasks.default]
alias = "start"

[tasks.start]
description = "Start in browser mode with auto-reload"
alias = "start-web"

[tasks.start-web]
description = "Start in web mode (MoonZoon SSE)"
dependencies = ["install"]
env = { NOVYWAVE_PLATFORM = "WEB" }
script = '''
> dev_server.log
./mzoon/bin/mzoon start ${@} >> dev_server.log 2>&1
'''

[tasks.open]
description = "Start in browser mode and open browser"
dependencies = ["install"]
script = '''
> dev_server.log
./mzoon/bin/mzoon start --open ${@} >> dev_server.log 2>&1
'''

[tasks.kill]
description = "Stop all development processes"
script = '''
PORT=$(grep "^port = " MoonZoon.toml | head -1 | cut -d' ' -f3 || echo "8080")
KILLED_ANY=false

echo "Stopping development processes on port $PORT..."

# Kill process on configured port
PID=$(lsof -ti:$PORT 2>/dev/null || true)
if [ -n "$PID" ]; then
    if kill -TERM $PID 2>/dev/null; then
        echo "Sent TERM signal to process on port $PORT"
        KILLED_ANY=true
    fi
fi

# Kill makers processes
if pkill -TERM -f "makers start" 2>/dev/null; then
    echo "Sent TERM signal to makers process"
    KILLED_ANY=true
fi

# Kill mzoon processes  
if pkill -TERM -f "mzoon" 2>/dev/null; then
    echo "Sent TERM signal to mzoon process"
    KILLED_ANY=true
fi

# Kill Tauri processes
if pkill -TERM -f "cargo tauri" 2>/dev/null; then
    echo "Sent TERM signal to Tauri process"
    KILLED_ANY=true
fi

if [ "$KILLED_ANY" = "true" ]; then
    echo "Waiting 2 seconds for graceful shutdown..."
    sleep 2
    
    # Force kill if still running
    PID=$(lsof -ti:$PORT 2>/dev/null || true)
    if [ -n "$PID" ]; then
        if kill -KILL $PID 2>/dev/null; then
            echo "Force killed process on port $PORT"
        fi
    fi
    
    pkill -KILL -f "makers start" 2>/dev/null && echo "Force killed makers process" || true
    pkill -KILL -f "mzoon" 2>/dev/null && echo "Force killed mzoon process" || true
    pkill -KILL -f "cargo tauri" 2>/dev/null && echo "Force killed Tauri process" || true
    
    echo "✓ Development processes terminated"
else
    echo "No development processes found to kill"
fi

> dev_server.log
> dev_tauri.log
'''

# Tauri-specific tasks
[tasks.tauri]
description = "Start in Tauri desktop mode using running dev server"
alias = "start-tauri"

[tasks.start-tauri]
description = "Start in Tauri mode using running dev server"
dependencies = ["install", "install_tauri_cli"]
env = { NOVYWAVE_PLATFORM = "TAURI" }
script = '''
echo "Starting Tauri desktop mode using dev server at http://localhost:8080..."

# Check if dev server is running on port 8080
if ! curl -s http://localhost:8080 >/dev/null 2>&1; then
    echo "ERROR: Dev server is not running on port 8080"
    echo "Please start the dev server first with: makers start"
    exit 1
fi

echo "✓ Dev server detected on port 8080"
echo "✓ Starting Tauri with shared dev server..."
echo "✓ Tauri logs will be written to dev_tauri.log"

> dev_tauri.log
cd src-tauri && cargo tauri dev --config tauri.dev.conf.json >> ../dev_tauri.log 2>&1
'''

[tasks.tauri-build]
description = "Build Tauri desktop app with embedded backend"
dependencies = ["install", "install_tauri_cli", "build-tauri", "tauri-build-bundle"]

[tasks.tauri-build-bundle]
description = "Bundle Tauri app (runs platform-specific task)"
dependencies = ["tauri-build-bundle-unix", "tauri-build-bundle-windows"]

[tasks.tauri-build-bundle-unix]
description = "Bundle Tauri app on Unix (Linux/macOS)"
condition = { platforms = ["linux", "mac"] }
env = { NOVYWAVE_PLATFORM = "TAURI" }
script_runner = "bash"
script = '''
set -e  # Exit on any error

# Create directories that Tauri resources require
mkdir -p frontend/pkg
mkdir -p plugins/dist

# Verify backend binary was built by mzoon
if [ -f "target/release/backend" ]; then
    echo "[OK] Backend binary found: target/release/backend"
else
    echo "ERROR: Backend binary not found at target/release/backend"
    echo "The mzoon build may have failed silently."
    echo "Contents of target/release/:"
    ls -la target/release/ 2>/dev/null | head -20 || echo "Directory does not exist"
    exit 1
fi

# Copy frontend pkg files for embedded backend lookup
BUILD_ID_FILE="frontend_dist/_api/pkg/build_id"
if [ -f "$BUILD_ID_FILE" ]; then
    BUILD_ID=$(cat "$BUILD_ID_FILE" | tr -d '[:space:]')
    echo "Build ID: $BUILD_ID"

    # Copy JS file
    JS_SRC="frontend_dist/_api/pkg/frontend_${BUILD_ID}.js"
    JS_DST="frontend/pkg/frontend_${BUILD_ID}.js"
    if [ -f "$JS_SRC" ]; then
        cp "$JS_SRC" "$JS_DST"
        echo "[OK] Copied JS file"
    fi

    # Copy WASM file
    WASM_SRC="frontend_dist/_api/pkg/frontend_bg_${BUILD_ID}.wasm"
    WASM_DST="frontend/pkg/frontend_bg_${BUILD_ID}.wasm"
    if [ -f "$WASM_SRC" ]; then
        cp "$WASM_SRC" "$WASM_DST"
        echo "[OK] Copied WASM file"
    fi

    # Copy snippets directory if exists
    SNIPPETS_DIR="frontend_dist/_api/pkg/snippets_${BUILD_ID}"
    SNIPPETS_DST="frontend/pkg/snippets_${BUILD_ID}"
    if [ -d "$SNIPPETS_DIR" ]; then
        cp -r "$SNIPPETS_DIR" "$SNIPPETS_DST"
        echo "[OK] Copied snippets directory"
    fi

    # Flatten _api for runtime lookup
    rm -rf _api
    cp -r frontend_dist/_api _api
    echo "[OK] Copied _api directory"
else
    echo "WARNING: Build ID file not found at $BUILD_ID_FILE"
fi

# Bundle release Tauri app
echo "Starting Tauri build..."
cd src-tauri

# If TAURI_BUILD_VERSION is set (from CI), override the version in tauri.conf.json
if [ -n "$TAURI_BUILD_VERSION" ]; then
    echo "[OK] Using version from CI: $TAURI_BUILD_VERSION"
    cargo tauri build --config "{\"version\": \"$TAURI_BUILD_VERSION\"}"
else
    cargo tauri build
fi
'''

[tasks.tauri-build-bundle-windows]
description = "Bundle Tauri app on Windows"
condition = { platforms = ["windows"] }
env = { NOVYWAVE_PLATFORM = "TAURI" }
script_runner = "powershell"
script_extension = "ps1"
script = '''
$ErrorActionPreference = "Stop"

# Create directories that Tauri resources require
New-Item -ItemType Directory -Force -Path "frontend/pkg" | Out-Null
New-Item -ItemType Directory -Force -Path "plugins/dist" | Out-Null

# Verify backend binary was built by mzoon
if (Test-Path "target/release/backend.exe") {
    Write-Host "[OK] Backend binary found: target/release/backend.exe"
} else {
    Write-Host "ERROR: Backend binary not found at target/release/backend.exe"
    Write-Host "The mzoon build may have failed silently."
    Write-Host "Contents of target/release/:"
    if (Test-Path "target/release") {
        Get-ChildItem "target/release" | Select-Object -First 20
    } else {
        Write-Host "Directory does not exist"
    }
    exit 1
}

# Copy frontend pkg files for embedded backend lookup
$BuildIdFile = "frontend_dist/_api/pkg/build_id"
if (Test-Path $BuildIdFile) {
    $BuildId = (Get-Content $BuildIdFile -Raw).Trim()
    Write-Host "Build ID: $BuildId"

    # Copy JS file
    $JsSrc = "frontend_dist/_api/pkg/frontend_$BuildId.js"
    $JsDst = "frontend/pkg/frontend_$BuildId.js"
    if (Test-Path $JsSrc) {
        Copy-Item $JsSrc $JsDst -Force
        Write-Host "[OK] Copied JS file"
    }

    # Copy WASM file
    $WasmSrc = "frontend_dist/_api/pkg/frontend_bg_$BuildId.wasm"
    $WasmDst = "frontend/pkg/frontend_bg_$BuildId.wasm"
    if (Test-Path $WasmSrc) {
        Copy-Item $WasmSrc $WasmDst -Force
        Write-Host "[OK] Copied WASM file"
    }

    # Copy snippets directory if exists
    $SnippetsDir = "frontend_dist/_api/pkg/snippets_$BuildId"
    $SnippetsDst = "frontend/pkg/snippets_$BuildId"
    if (Test-Path $SnippetsDir) {
        Copy-Item $SnippetsDir $SnippetsDst -Recurse -Force
        Write-Host "[OK] Copied snippets directory"
    }

    # Flatten _api for runtime lookup
    if (Test-Path "_api") {
        Remove-Item "_api" -Recurse -Force
    }
    Copy-Item "frontend_dist/_api" "_api" -Recurse -Force
    Write-Host "[OK] Copied _api directory"
} else {
    Write-Host "WARNING: Build ID file not found at $BuildIdFile"
}

# Bundle release Tauri app
Write-Host "Starting Tauri build..."
Set-Location "src-tauri"

# If TAURI_BUILD_VERSION is set (from CI), override the version in tauri.conf.json
$buildVersion = $env:TAURI_BUILD_VERSION
if ($buildVersion) {
    Write-Host "[OK] Using version from CI: $buildVersion"
    cargo tauri build --config "{`"version`": `"$buildVersion`"}"
} else {
    cargo tauri build
}
if ($LASTEXITCODE -ne 0) {
    exit $LASTEXITCODE
}
'''

[tasks.tauri-build-debug]
description = "Build Tauri desktop app in debug profile (AppImage only, devtools on)"
dependencies = ["install", "install_tauri_cli"]
env = { NOVYWAVE_PLATFORM = "TAURI" }
script = '''
# Build frontend for TAURI in debug (no -r) to keep devtools and symbols
NOVYWAVE_PLATFORM=TAURI ./mzoon/bin/mzoon build -f
# Duplicate hashed pkg files to deterministic names for embedded backend lookup
BUILD_ID_FILE=frontend_dist/_api/pkg/build_id
if [ -f "$BUILD_ID_FILE" ]; then
  BUILD_ID=$(cat "$BUILD_ID_FILE")
  cp "frontend_dist/_api/pkg/frontend_${BUILD_ID}.js" "frontend_dist/_api/pkg/frontend_0.js"
  cp "frontend_dist/_api/pkg/frontend_bg_${BUILD_ID}.wasm" "frontend_dist/_api/pkg/frontend_bg_0.wasm"
  mkdir -p frontend/pkg
  cp "frontend_dist/_api/pkg/frontend_${BUILD_ID}.js" "frontend/pkg/frontend_0.js"
  cp "frontend_dist/_api/pkg/frontend_bg_${BUILD_ID}.wasm" "frontend/pkg/frontend_bg_0.wasm"
  # Also copy hashed files with deterministic name the backend looks for
  cp "frontend_dist/_api/pkg/frontend_${BUILD_ID}.js" "frontend_dist/_api/pkg/frontend.js"
  cp "frontend_dist/_api/pkg/frontend_bg_${BUILD_ID}.wasm" "frontend_dist/_api/pkg/frontend_bg.wasm"

  # Flatten _api for runtime lookup (/_api/... relative to backend cwd)
  rm -rf _api
  mkdir -p _api
  cp -r frontend_dist/_api/* _api/
fi

# Bundle debug Tauri app; limit to appimage to speed things up
cd src-tauri && NOVYWAVE_PLATFORM=TAURI cargo tauri build --debug --bundles appimage --config tauri.conf.json
'''

[tasks.run-tauri-debug-appimage]
description = "Run debug AppImage with verbose logs and devtools"
script = '''
TAURI_LOG_LEVEL=debug RUST_LOG=debug target/debug/bundle/appimage/NovyWave_0.1.0_amd64.AppImage
'''

[tasks.tauri-dev-standalone]
description = "Start Tauri with external backend (for debugging)"
dependencies = ["install", "install_tauri_cli"]
script = '''
echo "Starting Tauri in standalone mode (requires separate backend)"
echo "Start backend separately with: makers start"
cd src-tauri && cargo tauri dev --no-dev-server
'''

# Common tasks
[tasks.install]
description = "Install all dependencies. It's NoOp if all deps are already installed."
dependencies = [
    "install_wasm_target", 
    "install_mzoon",
]

[tasks.build]
description = "Build for browser mode (release)"
env = { NOVYWAVE_PLATFORM = "WEB" }
command = "mzoon/bin/mzoon"
args = ["build", "-r", "-f"]

[tasks.build-web]
description = "Build for web mode (MoonZoon)"
env = { NOVYWAVE_PLATFORM = "WEB" }
command = "mzoon/bin/mzoon" 
args = ["build", "-r", "-f"]

[tasks.build-tauri]
description = "Build frontend for Tauri mode"
env = { NOVYWAVE_PLATFORM = "TAURI" }
command = "mzoon/bin/mzoon"
args = ["build", "-r", "-f"]

[tasks.build_for_tauri]
description = "Build frontend for Tauri (run from src-tauri directory)"
dependencies = ["install"]
script = '''
CURRENT_DIR=$(pwd)
if [[ "$CURRENT_DIR" == *"src-tauri"* ]]; then
    cd ..
fi
./mzoon/bin/mzoon build -r -f
'''

[tasks.clean]
description = "Clean all build artifacts"
script = '''
./mzoon/bin/mzoon clean
cd src-tauri && cargo clean
rm -rf frontend_dist
rm -rf plugins/dist
'''

######  HELPER TASKS  ######

[tasks.install_wasm_target]
description = "Install Rust target `wasm32-unknown-unknown`"
command = "rustup"
args = ["target", "add", "wasm32-unknown-unknown"]

[tasks.install_mzoon]
description = "Install MoonZoon CLI (mzoon) locally"
command = "cargo"
args = [
    "install", 
    "mzoon", 
    "--git", 
    "https://github.com/MoonZoon/MoonZoon",
    "--locked",
    "--rev",
    "7c5178d891cf4afbc2bbbe864ca63588b6c10f2a",
    "--root",
    "mzoon",
]

[tasks.build_plugins]
description = "Build all plugin components and copy artifacts to plugins/dist"
script_runner = "bash"
script = [
    "set -eu",
    "DIST_DIR=plugins/dist",
    "mkdir -p \"${DIST_DIR}\"",
    "mapfile -t targets < <(find plugins -maxdepth 2 -name Cargo.toml)",
    "if [ ${#targets[@]} -eq 0 ]; then echo 'No plugin manifests found under plugins/'; exit 0; fi",
    "for manifest in \"${targets[@]}\"; do echo \"Building component for ${manifest}\"; cargo component build --release --manifest-path \"${manifest}\"; done",
    "rm -f \"${DIST_DIR}\"/*.wasm",
    "find target/wasm32-wasip1/release -maxdepth 1 -name '*.wasm' -print -exec cp {} \"${DIST_DIR}/\" \\;",
    "echo \"Plugin components copied to ${DIST_DIR}/\""
]

[tasks.watch_plugins]
description = "Watch plugin sources and rebuild components"
script_runner = "bash"
script = [
    "set -eu",
    "> dev_plugins.log",
    "echo '[watch_plugins] watching plugins/**' >> dev_plugins.log",
    "cargo watch -w plugins -i 'plugins/dist/**' -s 'makers build_plugins' >> dev_plugins.log 2>&1"
]

[tasks.install_tauri_cli]
description = "Install Tauri CLI"
command = "cargo"
args = ["install", "tauri-cli@^2.9"]
